name: Test Suite

on:
  push:
    branches: [ main, develop ]
    paths-ignore:
      - 'create-package/package.json'  # Ignore version bump commits
  pull_request:
    branches: [ main ]

jobs:
  test-cli-tool:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18, 20]
        package-manager: [npm, yarn, pnpm]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v5
        with:
          node-version: ${{ matrix.node-version }}
          cache: ${{ matrix.package-manager }}
          cache-dependency-path: 'create-package/package-lock.json'

      - name: Install dependencies
        run: |
          cd create-package
          npm ci

      - name: Test CLI tool with ${{ matrix.package-manager }}
        run: |
          # Test CLI tool creation with different package managers
          cd /tmp
          node $GITHUB_WORKSPACE/create-package/bin/cli.js test-cli-${{ matrix.package-manager }} --no-install
          
          # Verify project structure
          test -d test-cli-${{ matrix.package-manager }}/client "Client directory should exist"
          test -d test-cli-${{ matrix.package-manager }}/server "Server directory should exist"
          test -f test-cli-${{ matrix.package-manager }}/package.json "Root package.json should exist"
          test -f test-cli-${{ matrix.package-manager }}/nx.json "Nx config should exist"
          
          echo "✅ CLI tool test passed for ${{ matrix.package-manager }}!"

      - name: Test generated project with ${{ matrix.package-manager }}
        run: |
          cd /tmp/test-cli-${{ matrix.package-manager }}
          
          # Install dependencies
          if [ "${{ matrix.package-manager }}" = "npm" ]; then
            npm ci
          elif [ "${{ matrix.package-manager }}" = "yarn" ]; then
            yarn install --frozen-lockfile
          elif [ "${{ matrix.package-manager }}" = "pnpm" ]; then
            pnpm install --frozen-lockfile
          fi
          
          # Test that the generated project can build
          npm run build:server
          npm run build:client
          
          # Test that tests can run
          npm run test:server
          npm run test:client
          
          echo "✅ Generated project test passed for ${{ matrix.package-manager }}!"

      - name: Cleanup
        if: always()
        run: |
          rm -rf /tmp/test-cli-*

  test-cli-options:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v5
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: 'create-package/package-lock.json'

      - name: Install dependencies
        run: |
          cd create-package
          npm ci

      - name: Test CLI with different options
        run: |
          cd /tmp
          
          # Test with Vite bundler
          node $GITHUB_WORKSPACE/create-package/bin/cli.js test-vite --no-install
          test -f test-vite/client/vite.config.ts "Vite config should exist"
          
          # Test with Webpack bundler
          node $GITHUB_WORKSPACE/create-package/bin/cli.js test-webpack --no-install
          test -f test-webpack/client/webpack.config.js "Webpack config should exist"
          
          # Test with Docker enabled
          node $GITHUB_WORKSPACE/create-package/bin/cli.js test-docker --no-install
          test -f test-docker/docker-compose.yml "Docker compose should exist"
          test -f test-docker/client/Dockerfile "Client Dockerfile should exist"
          test -f test-docker/server/Dockerfile "Server Dockerfile should exist"
          
          echo "✅ CLI options test passed!"

      - name: Cleanup
        if: always()
        run: |
          rm -rf /tmp/test-*

  test-cli-interactive:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v5
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: 'create-package/package-lock.json'

      - name: Install dependencies
        run: |
          cd create-package
          npm ci

      - name: Test CLI help and version
        run: |
          # Test help command
          node $GITHUB_WORKSPACE/create-package/bin/cli.js --help
          
          # Test version command
          node $GITHUB_WORKSPACE/create-package/bin/cli.js --version
          
          echo "✅ CLI help and version test passed!"

  test-error-handling:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v5
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: 'create-package/package-lock.json'

      - name: Install dependencies
        run: |
          cd create-package
          npm ci

      - name: Test error handling
        run: |
          cd /tmp
          
          # Test with existing directory (should fail)
          mkdir existing-dir
          if node $GITHUB_WORKSPACE/create-package/bin/cli.js existing-dir --no-install; then
            echo "❌ Should have failed with existing directory"
            exit 1
          fi
          
          # Test with invalid project name (should fail)
          if node $GITHUB_WORKSPACE/create-package/bin/cli.js "Invalid Name!" --no-install; then
            echo "❌ Should have failed with invalid project name"
            exit 1
          fi
          
          echo "✅ Error handling test passed!"

      - name: Cleanup
        if: always()
        run: |
          rm -rf /tmp/existing-dir